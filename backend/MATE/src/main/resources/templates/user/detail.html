<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì •ê²Œì‹œíŒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #FFF;
            margin: 0;
            padding: 0;
        }

        header {
            background: linear-gradient(90deg, #5b5fc7, #6B2399);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-left img {
            width: 50px;
            height: 50px;
            margin-right: 20px;
        }

        .header-left h1 {
            font-size: 50px;
            color: #FFF;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right span {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .header-right button {
            background-color: white;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
        }

        .header-right button:hover {
            background-color: #f1f1f1;
        }


    </style>
    <link rel="stylesheet" type="text/css" href="/css/boardDetail.css" />
    <link rel="stylesheet" type="text/css" href="/css/modal.css"/>
    <link rel="stylesheet" type="text/css" href="/css/header.css"/>
</head>
<body>
<header>
    <div class="header-left">
        <a href="/user/userMain">
            <img src="/img/logo.png" alt="Mate Logo" class="logo-img">
        </a>
        <h1>Mate</h1>
    </div>
    <div class="header-right">
        <span>{{userName}}ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤.</span>
        <button>ë§ˆì´í˜ì´ì§€</button>
        <button>ì •ì •ê²Œì‹œíŒ</button>
        <form action="/signOut" method="post" style="display:inline;">
            <button type="submit" class="nav-button">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    </div>
</header>
<div class="subtitle-container">
    <h2>ì •ì • ê²Œì‹œê¸€ ì‘ì„±</h2>
</div>
<!-- ëª¨ë‹¬ì°½ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>ë…ì„±ë°œì–¸ ì¡°íšŒ</h2>

        <!-- 1. ë¯¸íŒ… ì„ íƒ -->
        <div class="select-container">
            <label for="meetingSelect">íšŒì˜ ì„ íƒ:</label>
            <select id="meetingSelect" onchange="fetchToxicityLogs()">
                <option value="">íšŒì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">ë¯¸íŒ… A</option>
                <option value="2">ë¯¸íŒ… B</option>
                <option value="3">ë¯¸íŒ… C</option>
                <option value="4">ë¯¸íŒ… D</option>
            </select>
        </div>

        <!-- 2. ê²€ìƒ‰ì°½ (ë¯¸íŒ… ì„ íƒ ì „ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="search-container" class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="ë…ì„± ë°œì–¸ ê²€ìƒ‰..." onkeyup="filterList()">
        </div>

        <!-- 3. ë…ì„± ë°œì–¸ ë¦¬ìŠ¤íŠ¸ (ë¯¸íŒ… ì„ íƒ ì „ì—ëŠ” ìˆ¨ê¹€) -->
        <ul id="toxicity-list" class="toxicity-list">
            <!-- ë…ì„± ë°œì–¸ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
        </ul>

        <!-- 4. ì„ íƒ ì™„ë£Œ ë²„íŠ¼ -->
        <button id="confirmSelection" onclick="confirmToxicity()" style="display: none;">ì„ íƒ ì™„ë£Œ</button>
    </div>
</div>
<!-- ë©”ì¸ ë°•ìŠ¤ -->
<div class="container">
    {{#feedback}} <!-- /user/userFix/detail ì‹œ ë³´ì´ëŠ” form -->
    <form>
        <input type="hidden" name="userId" value="{{userId}}" id="userId">
        <div class="read-group">
            <label for="title">ì œëª©</label>
            <input type="text" id="title" name="title" value="{{title}}" readonly>
        </div>
        <div class="read-group">
            <label for="dateInput">ê¸°ê°„</label>
            <input id="dateInput" type="text" value="{{createdAt_format}}" name="createdAt" readonly>
        </div>
        <div class="read-group">
            <label for="toxicitySpeechLog">ë…ì„±ë°œì–¸ ì¡°íšŒ</label>
            <input type="text" id="toxicitySpeechLog" name="toxicitySpeechLog" value="{{toxicitySpeechLog_time}} / {{toxicitySpeechLog}}" readonly>
        </div>
        <div class="read-file-upload">
            <label for="filepath_read">ì²¨ë¶€ íŒŒì¼</label>
            <input type="text" id="filepath_read" name="filepath_read" value="{{filepath}}" readonly>
        </div>
        <div class="read-group">
            <label for="content">ë‚´ìš©</label>
            <textarea id="content" rows="6" name="content" readonly>{{content}}</textarea>
        </div>
        <div class="btnArea">
            <button onclick="goback()" id="backbtn" type="button" class="submit-btn">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </form>
    {{/feedback}}
    {{^feedback}} <!-- /user/userFix/write ì‹œ ë³´ì´ëŠ” form -->
    <form action="../userFix/write" method="post" enctype="multipart/form-data">
        <input type="hidden" name="userId" id="userId" value="{{userId}}">
        <div class="form-group">
            <label for="title">ì œëª©</label>
            <input type="text" id="title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
            <label for="date-range">ê¸°ê°„</label>
            <input id="date-range" type="date" name="createdAt">
        </div>
        <div class="form-group">
            <label for="toxicityId">ë…ì„±ë°œì–¸ ì¡°íšŒ</label>
            <input type="text" id="toxicityContent" name="toxicityContent" placeholder="ë…ì„±ë°œì–¸ì„ ì„ íƒí•˜ì„¸ìš”">
            <input type="hidden" id="toxicityId" name="toxicityId">
            <button type="button" id="searchBtn" onclick="openModal()" class="search-btn">ì¡°íšŒ</button>
        </div>
        <div class="file-upload">
            <label for="filepath">ì²¨ë¶€ íŒŒì¼</label>
            <input type="file" id="filepath" name="filepath">
        </div>
        <div class="form-group">
            <label for="content">ë‚´ìš©</label>
            <textarea id="content" rows="6" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="btnArea">
            <button id="submitBtn" onclick="check()" type="submit" class="submit-btn">ì œì¶œí•˜ê¸°</button>
            <button id="backBtn" onclick="goback()" type="button" class="submit-btn">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </form>
    {{/feedback}}
</div>
</body>
<script>
    //userFix/detail js
    document.addEventListener("DOMContentLoaded", function() {

        //filepathë¹ˆê°’ì¼ ì‹œ ëŒ€ì²´ë¬¸êµ¬
        const filepath = document.getElementById("filepath_read");
        if (filepath) {
            if (filepath.value.trim() === "") {
                filepath.value = "ì—…ë¡œë“œëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŒ";
            }
        }
    });

    function goback(){
        if (confirm("ì •ì •ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ë¡œ ë˜ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = "/user/userFix";
        }
    }
    function check(){
        if (!confirm("ì •ë§ ì •ì •ê²Œì‹œê¸€ ì‘ì„±ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨
        }
    }
    /* ëª¨ë‹¬ */

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal() {
        document.getElementById("modal").style.display = "flex";
        loadMeetings(); // ë¯¸íŒ… ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    // ë¯¸íŒ… ëª©ë¡ ë¡œë“œ (ë°±ì—”ë“œ API í˜¸ì¶œ)
    function loadMeetings() {
        const userId = document.getElementById("userId");
        console.log(">>> userId:"+userId.value);
        //ajax ìš”ì²­(javascript)
        fetch("/meeting/user/meetingInfo",{
            method:"POST",
            headers : {
                "Content-Type" : "application/json"
            },
            body : JSON.stringify({userId : userId.value})
        })
        .then(response => response.json())
        .then(data => {
            console.log("ë¯¸íŒ… ì •ë³´ : ", data);
            updateMeetingDropdown(data);
        })
        .catch(error => console.error("ë¯¸íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error));
    }
    //ë¯¸íŒ…ë¦¬ìŠ¤íŠ¸ ì…‹íŒ…
    function updateMeetingDropdown(meetings){
        const meetingSelect = document.getElementById("meetingSelect");
        // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
        meetingSelect.innerHTML = '<option value="">ë¯¸íŒ…ì„ ì„ íƒí•˜ì„¸ìš”</option>';

        meetings.forEach(meeting => {
            const option = document.createElement("option");
            option.value = meeting.meetingId; // ë¯¸íŒ… ID
            option.textContent = meeting.meetingName; // ë¯¸íŒ… ì´ë¦„
            meetingSelect.appendChild(option);
        });

        console.log("ë¯¸íŒ… ë“œë¡­ë‹¤ìš´ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:", meetings);
    }
    // íŠ¹ì • ë¯¸íŒ…ì˜ ë…ì„± ë°œì–¸ ì¡°íšŒ
    function fetchToxicityLogs() {
        const userId = document.getElementById("userId").value;
        const meetingId = document.getElementById("meetingSelect").value;
        const searchContainer = document.getElementById("search-container");
        console.log(">>> searchContainer"+searchContainer.style.display);
        const toxicityList = document.getElementById("toxicity-list");
        const confirmButton = document.getElementById("confirmSelection");
        //ì„ íƒ ë¯¸íŒ…ID
        console.log(">>> meetingId : "+meetingId);

        if (!meetingId) {
            // ë¯¸íŒ…ì„ ì„ íƒí•˜ì§€ì•Šì„ ê²½ìš° UI ì´ˆê¸°í™”
            resetToxicityList();
            return;
        }

        // ë¯¸íŒ…ì„ ì„ íƒí•˜ë©´ ê²€ìƒ‰ì°½, ë¦¬ìŠ¤íŠ¸, ë²„íŠ¼ ë³´ì´ê¸°
        searchContainer.style.display = "flex";
        toxicityList.style.display = "block";
        confirmButton.style.display = "block";

        //ë…ì„± ë°œì–¸ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        fetch("/toxic/userToxicLog",{
            method : "POST",
            headers : {"Content-Type" : "application/json"},
            body : JSON.stringify({meetingId : meetingId, userId: userId})
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                if(!response.ok){
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ : ${response.status}`); //404
                }
                return response.json();
            })
            .then(data => {
                console.log(">>> ë…ì„±ë°œì–¸ ì¡°íšŒ ê²°ê³¼ : ",data);
                updateToxicityList(data);
            })
            .catch(error =>{
                console.error("ë…ì„± ë°œì–¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                resetToxicityList();
            });

    }
    //ë…ì„±ë¦¬ìŠ¤íŠ¸ ì…‹íŒ…
    function updateToxicityList(toxicityLogs){
        const listContainer = document.getElementById("toxicity-list");
        listContainer.innerHTML = ""; //ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
        console.log(">>> updateToxicityList", toxicityLogs);

        if(!toxicityLogs || toxicityLogs.length === 0){
            listContainer.innerHTML = "<li class='empty-message'>ì¡°íšŒëœ ë…ì„± ë°œì–¸ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        toxicityLogs.forEach( log => {
            console.log(">> ë¦¬ìŠ¤íŠ¸ ìƒì„±",log.speechContent);
            const listItem = document.createElement("li");
            listItem.id = "txNum"+log.toxicityId;
            listItem.textContent = log.speechTimestamp+" / "+log.speechContent; //ë…ì„±ë°œì–¸ë¦¬ìŠ¤íŠ¸í‘œì‹œ
            listItem.classList.add("toxicity-item");

            listItem.addEventListener("click",function(){
                selectToxicity(this);
            });
            listContainer.appendChild(listItem);
        });
    }
    //ë…ì„± ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
    function resetToxicityList() {
        document.getElementById("search-container").style.display = "none";
        document.getElementById("toxicity-list").style.display = "none";
        document.getElementById("confirmSelection").style.display = "none";
        document.getElementById("toxicity-list").innerHTML = "";
    }
    // ë…ì„± ë°œì–¸ ê²€ìƒ‰ í•„í„°
    function filterList() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll("#toxicity-list li").forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(query) ? "" : "none";
        });
    }

    // ë…ì„± ë°œì–¸ ì„ íƒ
    let selectedContent = null;
    let selectedId = null;
    function selectToxicity(element) {
        document.querySelectorAll("#toxicity-list li").forEach(item => item.classList.remove("selected"));
        //í˜„ì¬ í´ë¦­ëœ ìš”ì†Œì— "selected" í´ë˜ìŠ¤ ì¶”ê°€
        element.classList.add("selected");
        //ì„ íƒëœ í…ìŠ¤íŠ¸ ì €ì¥
        selectedContent = element.textContent;
        selectedId = element.id;
        console.log(">>> ì„ íƒëœ ë…ì„± ë²ˆí˜¸:", selectedId);
        console.log(">>> ì„ íƒëœ ë…ì„± ë°œì–¸:", selectedContent);
    }

    // ì„ íƒ ì™„ë£Œ
    function confirmToxicity() {
        if (!selectedContent && !selectedId) {
            alert("ë…ì„± ë°œì–¸ì„ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }
        document.getElementById("toxicityContent").value = selectedContent;
        document.getElementById("toxicityId").value = selectedId.replace("txNum","");
        closeModal();
    }

</script>
</html>
