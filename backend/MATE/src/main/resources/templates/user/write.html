<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>μ •μ • κ²μ‹ν μ‘μ„±</title>
    <link rel="stylesheet" type="text/css" href="/css/boardDetail.css" />
    <link rel="stylesheet" type="text/css" href="/css/modal.css"/>
    <link rel="stylesheet" type="text/css" href="/css/header.css"/>
</head>
<body>
<header>
    <div class="header-left">
        <a href="/user/userMain">
            <img src="/img/logo.png" alt="Mate Logo" class="logo-img">
        </a>
        <h1>Mate</h1>
    </div>
    <div class="header-right">
        <span>{{userName}}λ‹ λ°κ°‘μµλ‹λ‹¤.</span>
        <button>λ§μ΄νμ΄μ§€</button>
        <button>μ •μ •κ²μ‹ν</button>
        <form action="/signOut" method="post" style="display:inline;">
            <button type="submit" class="nav-button">λ΅κ·Έμ•„μ›ƒ</button>
        </form>
    </div>
</header>

<div class="subtitle-container">
    <h2>μ •μ • κ²μ‹κΈ€ μ‘μ„±</h2>
</div>
<!-- λ¨λ‹¬μ°½ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>λ…μ„±λ°μ–Έ μ΅°ν</h2>

        <!-- 1. λ―Έν… μ„ νƒ -->
        <div class="select-container">
            <label for="meetingSelect">νμ μ„ νƒ:</label>
            <select id="meetingSelect" onchange="fetchToxicityLogs()">
                <option value="">νμλ¥Ό μ„ νƒν•μ„Έμ”</option>
                <option value="1">λ―Έν… A</option>
                <option value="2">λ―Έν… B</option>
                <option value="3">λ―Έν… C</option>
                <option value="4">λ―Έν… D</option>
            </select>
        </div>

        <!-- 2. κ²€μƒ‰μ°½ (λ―Έν… μ„ νƒ μ „μ—λ” μ¨κΉ€) -->
        <div id="search-container" class="search-container">
            <span class="search-icon">π”</span>
            <input type="text" id="searchInput" placeholder="λ…μ„± λ°μ–Έ κ²€μƒ‰..." onkeyup="filterList()">
        </div>

        <!-- 3. λ…μ„± λ°μ–Έ λ¦¬μ¤νΈ (λ―Έν… μ„ νƒ μ „μ—λ” μ¨κΉ€) -->
        <ul id="toxicity-list" class="toxicity-list">
            <!-- λ…μ„± λ°μ–Έ λ¦¬μ¤νΈκ°€ μ—¬κΈ°μ— μ¶”κ°€λ¨ -->
        </ul>

        <!-- 4. μ„ νƒ μ™„λ£ λ²„νΌ -->
        <button id="confirmSelection" onclick="confirmToxicity()" style="display: none;">μ„ νƒ μ™„λ£</button>
    </div>
</div>
<!-- λ©”μΈ λ°•μ¤ -->
<div class="container">
    <form action="../userFix/write" method="post" enctype="multipart/form-data">
        <input type="hidden" name="userId" id="userId" value="{{userId}}">

        <div class="form-group">
            <label for="title">μ λ©</label>
            <input type="text" id="title" name="title" placeholder="μ λ©μ„ μ…λ ¥ν•μ„Έμ”">
        </div>

        <div class="form-group">
            <label for="date-range">κΈ°κ°„</label>
            <input id="date-range" type="date" name="createdAt">
        </div>

        <div class="form-group">
            <label for="toxicityId">λ…μ„±λ°μ–Έ μ΅°ν</label>
            <input type="text" id="toxicityContent" name="toxicityContent" placeholder="λ…μ„±λ°μ–Έμ„ μ„ νƒν•μ„Έμ”">
            <input type="hidden" id="toxicityId" name="toxicityId">
            <button type="button" id="searchBtn" onclick="openModal()" class="search-btn">μ΅°ν</button>
        </div>

        <div class="file-upload">
            <label for="filepath">μ²¨λ¶€ νμΌ (MP3, WAV, M4Aλ§ κ°€λ¥)</label>
            <input type="file" id="filepath" name="filepath">
        </div>

        <div class="form-group">
            <label for="content">λ‚΄μ©</label>
            <textarea id="content" rows="6" name="content" placeholder="λ‚΄μ©μ„ μ…λ ¥ν•μ„Έμ”"></textarea>
        </div>

        <div class="btnArea">
            <button id="submitBtn" onclick="check()" type="submit" class="submit-btn">μ μ¶ν•κΈ°</button>
            <button id="backBtn" onclick="goback()" type="button" class="submit-btn">λ’¤λ΅κ°€κΈ°</button>
        </div>
    </form>
</div>
</body>
<script>
    //userFix/detail js
    document.addEventListener("DOMContentLoaded", function() {

        //filepathλΉκ°’μΌ μ‹ λ€μ²΄λ¬Έκµ¬
        const filepath = document.getElementById("filepath_read");
        if (filepath) {
            if (filepath.value.trim() === "") {
                filepath.value = "μ—…λ΅λ“λ μ²¨λ¶€νμΌμ΄ μ—†μ";
            }
        }
    });

    function goback(){
        if (confirm("μ •μ •κ²μ‹κΈ€ λ¦¬μ¤νΈλ΅ λλμ•„κ°€μ‹κ² μµλ‹κΉ?")) {
            window.location.href = "/user/userFix";
        }
    }

    function check(){
        if (!confirm("μ •λ§ μ •μ •κ²μ‹κΈ€ μ‘μ„±μ„ μ™„λ£ν•μ‹κ² μµλ‹κΉ?")) {
            event.preventDefault(); // νΌ μ μ¶ μ¤‘λ‹¨
        }
    }
    /* λ¨λ‹¬ */

    // λ¨λ‹¬ μ—΄κΈ°
    function openModal() {
        document.getElementById("modal").style.display = "flex";
        loadMeetings(); // λ―Έν… λ¦¬μ¤νΈ λ΅λ“
    }

    // λ¨λ‹¬ λ‹«κΈ°
    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    // λ―Έν… λ©λ΅ λ΅λ“ (λ°±μ—”λ“ API νΈμ¶)
    function loadMeetings() {
        const userId = document.getElementById("userId");
        console.log(">>> userId:"+userId.value);
        //ajax μ”μ²­(javascript)
        fetch("/meeting/user/meetingInfo",{
            method:"POST",
            headers : {
                "Content-Type" : "application/json"
            },
            body : JSON.stringify({userId : userId.value})
        })
            .then(response => response.json())
            .then(data => {
                console.log("λ―Έν… μ •λ³΄ : ", data);
                updateMeetingDropdown(data);
            })
            .catch(error => console.error("λ―Έν… λ°μ΄ν„° λ΅λ“ μ‹¤ν¨:", error));
    }
    //λ―Έν…λ¦¬μ¤νΈ μ…‹ν…
    function updateMeetingDropdown(meetings){
        const meetingSelect = document.getElementById("meetingSelect");
        // κΈ°μ΅΄ μµμ… μ΄κΈ°ν™” (μ²« λ²μ§Έ κΈ°λ³Έ μµμ… μ μ™Έ)
        meetingSelect.innerHTML = '<option value="">λ―Έν…μ„ μ„ νƒν•μ„Έμ”</option>';

        meetings.forEach(meeting => {
            const option = document.createElement("option");
            option.value = meeting.meetingId; // λ―Έν… ID
            option.textContent = meeting.meetingName; // λ―Έν… μ΄λ¦„
            meetingSelect.appendChild(option);
        });

        console.log("λ―Έν… λ“λ΅­λ‹¤μ΄μ΄ μ—…λ°μ΄νΈλμ—μµλ‹λ‹¤:", meetings);
    }
    // νΉμ • λ―Έν…μ λ…μ„± λ°μ–Έ μ΅°ν
    function fetchToxicityLogs() {
        const userId = document.getElementById("userId").value;
        const meetingId = document.getElementById("meetingSelect").value;
        const searchContainer = document.getElementById("search-container");
        console.log(">>> searchContainer"+searchContainer.style.display);
        const toxicityList = document.getElementById("toxicity-list");
        const confirmButton = document.getElementById("confirmSelection");
        //μ„ νƒ λ―Έν…ID
        console.log(">>> meetingId : "+meetingId);

        if (!meetingId) {
            // λ―Έν…μ„ μ„ νƒν•μ§€μ•μ„ κ²½μ° UI μ΄κΈ°ν™”
            resetToxicityList();
            return;
        }

        // λ―Έν…μ„ μ„ νƒν•λ©΄ κ²€μƒ‰μ°½, λ¦¬μ¤νΈ, λ²„νΌ λ³΄μ΄κΈ°
        searchContainer.style.display = "flex";
        toxicityList.style.display = "block";
        confirmButton.style.display = "block";

        //λ…μ„± λ°μ–Έ λ¦¬μ¤νΈ κ°€μ Έμ¤κΈ°
        fetch("/toxic/userToxicLog",{
            method : "POST",
            headers : {"Content-Type" : "application/json"},
            body : JSON.stringify({meetingId : meetingId, userId: userId})
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                if(!response.ok){
                    throw new Error(`μ„λ²„ μ‘λ‹µ μ¤λ¥ : ${response.status}`); //404
                }
                return response.json();
            })
            .then(data => {
                console.log(">>> λ…μ„±λ°μ–Έ μ΅°ν κ²°κ³Ό : ",data);
                updateToxicityList(data);
            })
            .catch(error =>{
                console.error("λ…μ„± λ°μ–Έ λ°μ΄ν„° λ΅λ“ μ‹¤ν¨:", error);
                resetToxicityList();
            });

    }
    //λ…μ„±λ¦¬μ¤νΈ μ…‹ν…
    function updateToxicityList(toxicityLogs){
        const listContainer = document.getElementById("toxicity-list");
        listContainer.innerHTML = ""; //κΈ°μ΅΄ λ©λ΅ λΉ„μ°κΈ°
        console.log(">>> updateToxicityList", toxicityLogs);

        if(!toxicityLogs || toxicityLogs.length === 0){
            listContainer.innerHTML = "<li class='empty-message'>μ΅°νλ λ…μ„± λ°μ–Έμ΄ μ—†μµλ‹λ‹¤.</li>";
            return;
        }

        toxicityLogs.forEach( log => {
            console.log(">> λ¦¬μ¤νΈ μƒμ„±",log.speechContent);
            const listItem = document.createElement("li");
            listItem.id = "txNum"+log.toxicityId;
            listItem.textContent = log.speechTimestamp+" / "+log.speechContent; //λ…μ„±λ°μ–Έλ¦¬μ¤νΈν‘μ‹
            listItem.classList.add("toxicity-item");

            listItem.addEventListener("click",function(){
                selectToxicity(this);
            });
            listContainer.appendChild(listItem);
        });
    }
    //λ…μ„± λ¦¬μ¤νΈ μ΄κΈ°ν™”
    function resetToxicityList() {
        document.getElementById("search-container").style.display = "none";
        document.getElementById("toxicity-list").style.display = "none";
        document.getElementById("confirmSelection").style.display = "none";
        document.getElementById("toxicity-list").innerHTML = "";
    }
    // λ…μ„± λ°μ–Έ κ²€μƒ‰ ν•„ν„°
    function filterList() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll("#toxicity-list li").forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(query) ? "" : "none";
        });
    }

    // λ…μ„± λ°μ–Έ μ„ νƒ
    let selectedContent = null;
    let selectedId = null;
    function selectToxicity(element) {
        document.querySelectorAll("#toxicity-list li").forEach(item => item.classList.remove("selected"));
        //ν„μ¬ ν΄λ¦­λ μ”μ†μ— "selected" ν΄λμ¤ μ¶”κ°€
        element.classList.add("selected");
        //μ„ νƒλ ν…μ¤νΈ μ €μ¥
        selectedContent = element.textContent;
        selectedId = element.id;
        console.log(">>> μ„ νƒλ λ…μ„± λ²νΈ:", selectedId);
        console.log(">>> μ„ νƒλ λ…μ„± λ°μ–Έ:", selectedContent);
    }

    // μ„ νƒ μ™„λ£
    function confirmToxicity() {
        if (!selectedContent && !selectedId) {
            alert("λ…μ„± λ°μ–Έμ„ μ„ νƒν•μ„Έμ”!");
            return;
        }
        document.getElementById("toxicityContent").value = selectedContent;
        document.getElementById("toxicityId").value = selectedId.replace("txNum","");
        closeModal();
    }

</script>
</html>